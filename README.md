# GoIda API

REST API для управления пользователями и статьями с системой авторизации и ролями.

## Возможности

- **Две связанные сущности**: Пользователи и Статьи (связь один-ко-многим)
- **Система авторизации**: JWT токены с Bearer аутентификацией
- **Роли пользователей**: `user` (обычный пользователь) и `admin` (администратор)
- **Валидация данных**: Проверка входных данных на уровне API
- **Права доступа**: Пользователи могут редактировать только свои объекты, админы - любые

## Структура базы данных

База данных содержит 4 основные таблицы:
- `roles` - справочник ролей пользователей
- `users` - профили пользователей
- `auth_credentials` - данные для аутентификации (логины и пароли)
- `articles` - статьи пользователей

Подробное описание полей таблиц доступно в комментариях к миграциям базы данных.

## API Endpoints

### Публичные маршруты

#### Регистрация пользователя
```
POST /api/users
Content-Type: application/json

{
  "email": "user@example.com",
  "name": "Test User"
}
```

#### Авторизация
```
POST /api/auth/login
Content-Type: application/json

{
  "login": "user",
  "password": "password"
}
```

Ответ:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "name": "Test User",
    "role_id": 1,
    "role": {
      "id": 1,
      "name": "user",
      "description": "Обычный пользователь"
    },
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```

#### Получение списка статей
```
GET /api/articles?limit=10&offset=0
```

#### Получение конкретной статьи
```
GET /api/articles/{id}
```

#### Получение статей пользователя
```
GET /api/users/{authorId}/articles?limit=10&offset=0
```

#### Получение списка ролей (только для админов)
```
GET /api/admin/roles
Authorization: Bearer ADMIN_TOKEN
```

#### Получение конкретной роли (только для админов)
```
GET /api/admin/roles/{id}
Authorization: Bearer ADMIN_TOKEN
```

### Защищенные маршруты (требуют авторизации)

#### Получение профиля
```
GET /api/auth/profile
Authorization: Bearer YOUR_TOKEN
```

#### Создание статьи
```
POST /api/articles
Authorization: Bearer YOUR_TOKEN
Content-Type: application/json

{
  "title": "Заголовок статьи",
  "content": "Содержимое статьи"
}
```

#### Обновление статьи
```
PUT /api/articles/{id}
Authorization: Bearer YOUR_TOKEN
Content-Type: application/json

{
  "title": "Новый заголовок",
  "content": "Новое содержимое"
}
```

#### Удаление статьи
```
DELETE /api/articles/{id}
Authorization: Bearer YOUR_TOKEN
```

#### Получение информации о пользователе
```
GET /api/users/{id}
Authorization: Bearer YOUR_TOKEN
```


### Админские маршруты (требуют роль admin)

#### Получение списка пользователей
```
GET /api/admin/users?limit=10&offset=0
Authorization: Bearer ADMIN_TOKEN
```

## Коды ответов

- `200` - Успешный ответ
- `201` - Успешный ответ (при добавлении объекта)
- `202` - Accepted
- `400` - Некорректный формат запроса/неверный запрос
- `401` - Требуется аутентификация (не авторизован)
- `403` - Нет доступа (авторизован, но не имеет таких прав)
- `404` - Не найден
- `422` - Неверные данные (например, не хватает данных для создания объекта)

## Валидация данных

### Пользователь
- `email`: обязательное поле, валидный email
- `name`: обязательное поле, минимум 2 символа

### Аутентификация
- `login`: обязательное поле, минимум 3 символа
- `password`: обязательное поле

### Статья
- `title`: обязательное поле, минимум 3 символа
- `content`: обязательное поле, минимум 10 символов

## Права доступа

### Обычные пользователи (role: user)
- Могут создавать, редактировать и удалять только свои статьи
- Могут просматривать информацию о других пользователях
- Не могут видеть список всех пользователей

### Администраторы (role: admin)
- Могут создавать, редактировать и удалять любые статьи
- Могут видеть список всех пользователей
- Пользователи не могут быть удалены через API (только мягкое удаление)

## Установка и запуск

### С помощью Docker Compose (рекомендуется)

1. Настройте переменные окружения (скопируйте `env.example` в `.env`):
```bash
cp env.example .env
```

2. Запустите все сервисы:
```bash
docker-compose up -d
```

### Локальная разработка

1. Установите зависимости:
```bash
go mod tidy
```

2. Настройте переменные окружения:
```bash
cp env.example .env
```

3. Запустите базу данных:
```bash
docker-compose up -d db
```

4. Запустите миграции:
```bash
make migrate-up
```

5. Запустите приложение:
```bash
go run main.go
```

## Тестирование

Используйте файл `api-tests.http` для тестирования API с помощью HTTP-клиента (например, VS Code REST Client).

### Тестовые данные

- **Админ**: логин `admin`, пароль `password`
- **Пользователь**: логин `user`, пароль `password`

## Архитектура

- **Модульная структура**: разделение на `app`, `handlers`, `services`, `repository`
- **Отдельная сущность аутентификации**: `AuthCredentials` для логинов и паролей
- **Авторизация только по логину**: email не используется для входа
- **Ролевая модель**: пользователи и администраторы с разными правами

## Технологии

- **Go 1.21+**
- **PostgreSQL** - база данных
- **Liquibase** - миграции базы данных
- **JWT** - авторизация
- **bcrypt** - хеширование паролей
- **Gorilla Mux** - HTTP роутер
- **Validator** - валидация данных
- **Docker Compose** - оркестрация сервисов